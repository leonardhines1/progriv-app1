name: ğŸ”¨ Build Windows EXE

on:
  push:
    branches: [main]
  workflow_dispatch:  # Ğ ÑƒÑ‡Ğ½Ğ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ· GitHub UI

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      # â”€â”€ 1. Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ ĞºĞ¾Ğ´ â”€â”€
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # â”€â”€ 2. Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Python â”€â”€
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      # â”€â”€ 3. Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ– â”€â”€
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # â”€â”€ 4. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° ÑĞ¸Ğ½Ñ‚Ğ°ĞºÑĞ¸ÑÑƒ Ğ²ÑÑ–Ñ… Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ² â”€â”€
      - name: ğŸ” Syntax check
        run: |
          python -m py_compile main.py
          python -m py_compile app/gui.py
          python -m py_compile app/api_client.py
          python -m py_compile app/generator.py
          python -m py_compile app/error_parser.py
          python -m py_compile app/key_codec.py
          python -m py_compile app/constants.py
          echo "âœ… All files syntax OK"

      # â”€â”€ 5. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ñ–Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ–Ğ² â”€â”€
      - name: ğŸ”— Import check
        run: |
          python -c "from app.gui import App; print('âœ… GUI import OK')"
          python -c "from app.api_client import GistResolver, SheetAPI; print('âœ… API import OK')"
          python -c "from app.generator import AdsGenerator; print('âœ… Generator import OK')"
          python -c "from app.error_parser import parse_error_csv; print('âœ… ErrorParser import OK')"
          python -c "from app.key_codec import smart_decode; print('âœ… KeyCodec import OK')"

      # â”€â”€ 6. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ Ğ´Ğ¾ Gist â”€â”€
      - name: ğŸŒ Network check (Gist)
        continue-on-error: true
        run: |
          python -c "from app.api_client import GistResolver; gist = GistResolver(); config = gist.fetch_config(); print(f'Gist OK: source={config.get(chr(95)+chr(115)+chr(111)+chr(117)+chr(114)+chr(99)+chr(101))}, model={config.get(chr(103)+chr(101)+chr(109)+chr(105)+chr(110)+chr(105)+chr(95)+chr(109)+chr(111)+chr(100)+chr(101)+chr(108))}')"

      # â”€â”€ 7. Ğ—Ğ±Ñ–Ñ€ĞºĞ° .exe â”€â”€
      - name: ğŸ”¨ Build EXE
        run: |
          python -m PyInstaller Progriv_win.spec --clean --noconfirm

      # â”€â”€ 8. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ñ‰Ğ¾ .exe Ñ–ÑĞ½ÑƒÑ” â”€â”€
      - name: ğŸ“ Verify EXE
        run: |
          $exe = "dist\ĞŸÑ€Ğ¾Ğ³Ñ€Ñ–Ğ².exe"
          if (Test-Path $exe) {
            $size = (Get-Item $exe).Length / 1MB
            Write-Host "âœ… ĞŸÑ€Ğ¾Ğ³Ñ€Ñ–Ğ².exe exists: $([math]::Round($size, 1)) MB"
            if ($size -lt 5) { throw "EXE too small: $size MB" }
            if ($size -gt 100) { throw "EXE too large: $size MB" }
          } else {
            throw "âŒ ĞŸÑ€Ğ¾Ğ³Ñ€Ñ–Ğ².exe not found!"
          }
        shell: pwsh

      # â”€â”€ 9. Smoke-test: Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğ¸ .exe Ñ– Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ñ‚Ğ¸ Ñ‰Ğ¾ Ğ½Ğµ ĞºÑ€Ğ°ÑˆĞ¸Ñ‚ÑŒÑÑ â”€â”€
      - name: ğŸ§ª Smoke test EXE
        run: |
          python tests/smoke_test.py
        timeout-minutes: 2

      # â”€â”€ 10. Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ğ¹ .exe ÑĞº Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚ â”€â”€
      - name: ğŸ“¤ Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: ĞŸÑ€Ğ¾Ğ³Ñ€Ñ–Ğ²-Windows
          path: dist/ĞŸÑ€Ğ¾Ğ³Ñ€Ñ–Ğ².exe
          retention-days: 90
          if-no-files-found: error
