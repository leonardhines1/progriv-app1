name: Build Windows EXE

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Syntax check
        run: |
          python -m py_compile main.py
          python -m py_compile app/gui.py
          python -m py_compile app/api_client.py
          python -m py_compile app/generator.py
          python -m py_compile app/error_parser.py
          python -m py_compile app/key_codec.py
          python -m py_compile app/constants.py
          echo "All files syntax OK"

      - name: Import check
        run: |
          python -c "from app.gui import App; print('GUI import OK')"
          python -c "from app.api_client import GistResolver, SheetAPI; print('API import OK')"
          python -c "from app.generator import AdsGenerator; print('Generator import OK')"
          python -c "from app.error_parser import parse_error_csv; print('ErrorParser import OK')"
          python -c "from app.key_codec import smart_decode; print('KeyCodec import OK')"

      - name: Network check (Gist)
        continue-on-error: true
        run: |
          python -c "from app.api_client import GistResolver; gist = GistResolver(); config = gist.fetch_config(); print('Gist OK: model=' + str(config.get('gemini_model')))"

      - name: Build EXE
        run: |
          python -m PyInstaller Progriv_win.spec --clean --noconfirm

      - name: Verify EXE
        run: |
          $exeFiles = Get-ChildItem -Path "dist" -Filter "*.exe" -ErrorAction SilentlyContinue
          if ($exeFiles.Count -eq 0) {
            throw "No .exe found in dist/"
          }
          $exe = $exeFiles[0]
          $size = $exe.Length / 1MB
          Write-Host ("EXE found: {0} ({1:N1} MB)" -f $exe.Name, $size)
          if ($size -lt 5) { throw ("EXE too small: {0:N1} MB" -f $size) }
          if ($size -gt 100) { throw ("EXE too large: {0:N1} MB" -f $size) }
        shell: pwsh

      - name: Smoke test EXE
        continue-on-error: true
        run: |
          python tests/smoke_test.py
        timeout-minutes: 2

      - name: Upload EXE artifact
        uses: actions/upload-artifact@v4
        with:
          name: Progriv-Windows
          path: dist/*.exe
          retention-days: 90
          if-no-files-found: error
